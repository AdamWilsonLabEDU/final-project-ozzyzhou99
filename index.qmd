---
title: "Assessing the Accessibility and Equity of Public Green Spaces in Buffalo"
author: "Zhongyu Zhou"
subtitle: "A Spatial Analysis of Urban Green Space Distribution"
date: today
date-format: long
format: 
  html:
    embed-resources: true
    toc: true
    toc-depth: 3
    code-fold: true
    theme: cosmo
    navbar:
      left:
        - text: "Home"
          href: index.html
---

# Introduction

Public green spaces play a vital role in urban environments, contributing to both physical and mental health of residents. In the context of increasing urbanization and environmental challenges, the accessibility of these spaces directly impacts quality of life. However, green space distribution in cities often shows disparities, potentially creating inequitable access across different communities.

This study focuses on Buffalo, New York, analyzing the spatial distribution and accessibility of public green spaces. The primary research questions are:

1. How accessible are public green spaces to Buffalo residents within a 5-minute walking distance?
2. Are there significant disparities in green space accessibility across different neighborhoods?
3. What is the relationship between income levels and green space accessibility?

# Materials and methods

This analysis integrates data from two primary sources:

1. OpenStreetMap (OSM): Provides spatial data on public green spaces, including parks and gardens
2. American Community Survey (ACS): Supplies demographic information including population density and median income at the census tract level

The methodology follows these key steps:

1. Data Collection and Processing:
   - Extract green space polygons from OSM using the 'osmdata' package
   - Obtain demographic data using the 'tidycensus' package
   - Transform all spatial data to a consistent coordinate reference system

2. Accessibility Analysis:
   - Calculate 400-meter (5-minute walking distance) buffers around green spaces
   - Compute accessibility scores based on the intersection of these buffers with census tracts
   - Analyze the relationship between accessibility and demographic factors

```{r setup, message=F, warning=F}
library(osmdata)
library(sf)
library(ggplot2)
library(tidyverse)
library(tidycensus)
library(tigris)
library(units)
library(kableExtra)

# Set Census API key
census_api_key("71ee368dd6a9d472f0ba814e6f90b8566a1a7192")
```

## Data Collection and Processing

```{r data-collection, message=FALSE, warning=FALSE, results='hide'}
# Get Buffalo city boundary
buffalo_boundary <- places(state = "NY") %>%
  filter(NAME == "Buffalo") %>%
  st_transform(4326)

# Get green spaces data
buffalo_bbox <- st_bbox(buffalo_boundary)
buffalo_green <- opq(buffalo_bbox) %>%
  add_osm_feature(key = "leisure", value = c("park", "garden")) %>%
  osmdata_sf()

# Process green spaces
green_spaces <- buffalo_green$osm_polygons %>%
  select(osm_id, name) %>%
  st_transform(4326) %>%
  st_intersection(buffalo_boundary)

# Get demographic data
buffalo_pop <- get_acs(
  geography = "tract",
  variables = c(
    population = "B01003_001",
    median_income = "B19013_001"
  ),
  state = "NY",
  county = "Erie",
  year = 2020,
  geometry = TRUE
) %>%
  select(-moe) %>%
  pivot_wider(
    id_cols = c(GEOID, geometry),
    names_from = "variable",
    values_from = "estimate"
  ) %>%
  st_as_sf() %>%
  st_transform(4326) %>%
  st_intersection(buffalo_boundary)
```

## Accessibility Analysis

```{r accessibility, message=FALSE, warning=FALSE, results='hide'}
calculate_accessibility <- function(tract, green_spaces, buffer_distance = 400) {
  tryCatch({
    # Convert to projected coordinate system
    tract_proj <- st_transform(st_geometry(tract), 32617)
    green_spaces_proj <- st_transform(green_spaces, 32617)
    
    # Get population data
    tract_population <- tract$population
    tract_area_km2 <- as.numeric(st_area(tract_proj)) / 1000000  # 转换到平方公里
    population_density <- tract_population / tract_area_km2
    
    # Create a buffer
    tract_buffer <- st_buffer(tract_proj, buffer_distance)
    
    # Find accessible green space
    intersecting <- st_intersects(tract_buffer, green_spaces_proj)
    
    if(length(unlist(intersecting)) == 0) {
      return(0)
    }
    
    # Get the intersecting green space
    accessible_gs <- green_spaces_proj[unlist(intersecting),]
    
    # Calculate intersection
    intersection <- st_intersection(tract_buffer, accessible_gs)
    
    # Basic calculations
    intersection_area <- sum(st_area(intersection))
    tract_area <- st_area(tract_proj)
    
    # 1. Basic coverage
    coverage_ratio <- as.numeric(intersection_area) / as.numeric(tract_area)
    
    # 2. Green space size weight
    gs_sizes <- st_area(accessible_gs)
    size_weight <- 1 + log1p(as.numeric(gs_sizes) / min(as.numeric(gs_sizes)))
    
    # 3. Distance weight
    distances <- st_distance(tract_proj, accessible_gs)
    distance_weights <- 1 - (as.numeric(distances) / buffer_distance)
    distance_weights[distance_weights < 0] <- 0
    
    # 4. Population density weight
    # Use an inverse relationship: the higher the population density, the greater the demand for green space
    density_factor <- 1 + log1p(population_density / mean(buffalo_pop$population / 
                                                        (as.numeric(st_area(buffalo_pop)) / 1000000)))
    
    # Comprehensive calculation
    # When the population density is high, the same green space coverage will get a lower score
    weighted_score <- coverage_ratio * mean(size_weight * distance_weights) / density_factor
    
    # Normalize to between 0 and 1
    return(min(1, weighted_score))
    
  }, error = function(e) {
    warning(paste("计算错误:", e$message))
    return(0)
  })
}

buffalo_pop$accessibility <- sapply(
  1:nrow(buffalo_pop),
  function(i) {
    if(i %% 10 == 0) cat(sprintf("Processing tract %d of %d\n", i, nrow(buffalo_pop)))
    calculate_accessibility(buffalo_pop[i,], green_spaces)
  }
)
```

# Results

Our analysis reveals several key findings about green space accessibility in Buffalo:

```{r results, fig.width=10, fig.height=8}
# Create accessibility map
ggplot() +
  geom_sf(data = buffalo_pop, aes(fill = accessibility)) +
  scale_fill_viridis_c(
    name = "Accessibility Score",
    limits = c(0, 1),
    labels = scales::percent,
    na.value = "grey50"
  ) +
  geom_sf(data = green_spaces, fill = "darkgreen", alpha = 0.3) +
  theme_minimal() +
  labs(
    title = "Green Space Accessibility in Buffalo",
    subtitle = "Percentage of area within 5-minute walking distance of green spaces"
  )
```

```{r income-analysis, message=FALSE, warning=FALSE}
# Data cleaning and outlier handling
buffalo_pop_clean <- buffalo_pop %>%
  # Remove outliers in income
  filter(!is.na(median_income)) %>%
  filter(median_income > quantile(median_income, 0.01, na.rm = TRUE) &
         median_income < quantile(median_income, 0.99, na.rm = TRUE)) %>%
  # Remove extreme values ​​of accessibility
  filter(accessibility > quantile(accessibility, 0.01, na.rm = TRUE) &
         accessibility < quantile(accessibility, 0.99, na.rm = TRUE))

# Create income quantiles
buffalo_pop_clean <- buffalo_pop_clean %>%
  mutate(
    income_quintile = cut(median_income,
                         breaks = quantile(median_income, probs = seq(0, 1, 0.2), na.rm = TRUE),
                         labels = c("Lowest 20%", "20-40%", "40-60%", "60-80%", "Highest 20%"),
                         include.lowest = TRUE)
  )

# Calculate the average accessibility for each income quantile
quintile_summary <- buffalo_pop_clean %>%
  group_by(income_quintile) %>%
  summarise(
    mean_accessibility = mean(accessibility, na.rm = TRUE),
    median_accessibility = median(accessibility, na.rm = TRUE),
    n_tracts = n()
  )

# Create a scatter plot
improved_income_plot <- ggplot(buffalo_pop_clean, 
                             aes(x = median_income, y = accessibility)) +
  # Add scatter points
  geom_point(aes(color = income_quintile), 
             shape = 18,  
             size = 3) +
  # Add a trend line
  geom_smooth(method = "loess", color = "black", linetype = "dashed") +
  scale_x_continuous(labels = scales::dollar_format(),
                    breaks = scales::pretty_breaks(n = 8)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1),
                    limits = c(0, 1)) +
  scale_color_manual(values = c("#4B0082", "#4682B4", "#2E8B57", "#FFA500", "#DC143C")) +
  theme_minimal() +
  labs(
    title = "Relationship between Income and Green Space Accessibility",
    subtitle = "With smoothed trend line",
    x = "Median Household Income",
    y = "Green Space Accessibility Score",
    color = "Income Quintile" 
  )

print(improved_income_plot)

# Display quantile statistics
knitr::kable(quintile_summary, 
             caption = "Accessibility Statistics by Income Quintile") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

# Conclusions

The results show a complex pattern of green space accessibility in Buffalo:

1. The spatial distribution is uneven, with higher accessibility in the Northeast and Midwest and lower accessibility in the Central and Southeast.

2. Accessibility has a U-shaped relationship with income, with middle-income communities having the lowest accessibility.

3. Accessibility is higher around major parks and lower in densely populated areas.

Our improved approach takes into account spatial coverage and population density, revealing nuances in green space accessibility that go beyond simple income differences. Future research could incorporate road network analysis, historical development patterns, other socioeconomic factors, green space quality, and seasonal changes. These findings could inform policies for more equitable green space allocation, especially improving accessibility in middle-income communities while also taking into account low- and high-income communities.

# References

1. Buffalo Green Space Data: OpenStreetMap Contributors
2. Demographic Data: U.S. Census Bureau, American Community Survey 2016-2020
3. Spatiotemporal patterns and inequity of urban green space accessibility study
4. Analysis of urban green space accessibility and distribution inequity in the City of Chicago
5. GIS-based analysis of the urban green space accessibility in Craiova city, Romania
